<!--
A Pen created at CodePen.io. You can find this one at https://codepen.io/ace-subido/pen/Cuiep.
Using default Bootstrap 3.0, here's a short CSS snippet to style your login form.
-->
<!DOCTYPE html>
<html lang="en" >
<head>
	<meta charset="UTF-8">
	<title>SkeptCha: Login </title>
	<link rel='stylesheet prefetch' href='http://netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css'>
  <link rel="stylesheet" href="css/style.css">
  <script type="text/javascript" src="drawCanvas.js"></script>
  <script type="text/javascript" src="sketchDebugger.js"></script>
  <script type="text/javascript" src="SketchRecTools.js"></script>
  <script type="text/javascript" src="shortStraw.js"></script>
  <script type="text/javascript" src="triangleRecognizer.js"></script>
  
</head>

<body onload="start()">
	<div class="wrapper">
	<form class="form-signin">       
	  <h2 class="form-signin-heading">Please login</h2>
	  <input type="text" class="form-control" name="username" placeholder="Email Address" required="" autofocus="" />
	  <input type="password" class="form-control" name="password" placeholder="Password" required=""/>      
	  <label class="checkbox">
	    <input type="checkbox" value="remember-me" id="rememberMe" name="rememberMe"> Remember me
	  </label>
    <div>
        <p>Please draw the given image :) </p>
    </div>
     <div>
      <canvas id="drawCanvas" class="canvaslook" width="200" height="200" ></canvas>
    </div>
        
    <div>
      <canvas id="viewCanvas" class="canvasView" width="200" height="200" ></canvas>
    </div>
        <!-- Buttons Section -->
    <div>
      <input type="submit" value="Clear" class="elementlook" onclick="clearButton(drawCanvas, drawContext);">
      <input type="submit" value="Undo" class="elementlook" onclick="undoButton(drawCanvas, drawContext);">
    <input type="submit" value="reCaptCha" class="elementlook" onclick="">
      <input type="submit" value="Validate" class="elementlook" onclick="validateSkeptCha();">
    </div>

	  <button class="btn btn-lg btn-primary btn-block" type="submit">Login</button>   
	</form>
	</div>
    
   


<script type="text/javascript">

  function start(){
      loadSkeptCha();
      initDrawing();
      //
  }


  var recognizing = "Dummy"; // Current interpretation of sketch
  var indexFile;  // File Storing Sketch Ids for a particular Interpretation

  function loadSkeptCha() {
    // get the canvas and its context
    viewCanvas = document.getElementById('viewCanvas');
    if (viewCanvas.getContext) {
      viewContext = viewCanvas.getContext('2d');
    }
    var localSketch = readJson('Data/Others/defaultSketch.json')

    // Select Random Interpretation
    var totalInterpretations = 1;
    var choose = Math.floor(totalInterpretations * Math.random());

    switch(choose) {
      case 0:
      default:      // Triangle
          indexFile = readJson('Data/Triangle.json');
          // console.log(indexFile);

          var localId = indexFile[Math.floor(indexFile.length * Math.random())];
          // console.log(localId);
          if (localId) {
              localSketch = readJson('Data/Sketch_Triangle/' + localId + '.json');
          }
    }

    console.log("Loaded sketch:")
    console.log(localSketch)
    displaySketchInContext(localSketch,strokeColor, viewContext)
    recognizing = localSketch.shapes[0].interpretation;
  }

   
  function validateSkeptCha() {
    drawCanvas = document.getElementById('drawCanvas');

    var sketch = getSkeptCha(drawCanvas, recognizing);
    // console.log(sketch);
    if (!sketch) {
      // Show Notification - Cannot validate empty sketch.. Please draw the given image.
    }

    var SamplingDist = SketchRecTools.determineResampleSpacing(sketch);
    var resampledSketch = SketchRecTools.resampleByDistance(sketch, SamplingDist);
    console.log("Resampled Sketch");
    console.log(resampledSketch);

    var result = false;
    
    //Select appropriate recognizer as per the interpretation being recognized

    result = TriangleRecognizer.validate(resampledSketch, SamplingDist);


    if(result) {
      console.log("SkeptCha Validation Pass");
      saveSketch(sketch);
    } else {
      console.log("SkeptCha Validation Fail");
      //TODO reduce confidence level of displayed sketch and save the drawn sketch to otherSketches folder
    }
    return result;
  }



  /**
   * Retrieve the currently drawn sketch from the canvas without clearing it
   * @param {Object} canvas - The draw canvas.
   */
  function getSkeptCha(canvas, interpretation) {
    // get the sketch's strokes and validate
    var strokes = DrawCanvasData.strokes;
    if (strokes.length == 0){
      // console.log("Cannot validate empty sketch. Please draw the given image.");
      return;
    }
    
    // get the sketch's interpretation 
    if (interpretation === "") {
      interpretation = "none";
    }

    // get the sketch's domain(s) 
    var domainString = "SkeptCha";

    // parse the domains into an array
    var domainString = domainString.replace(/ /g, ''); // removes whitespace
    var domain = domainString.split(",");

    
    // Set up sketch object
    var id = generateUuidv4();

    // get the sketch's first time
    var firstTime = strokes[0].points[0].time;

    // create the sketch's shapes object
    var shape = {};
    shape.subElements = [];
    for (var i = 0; i < strokes.length; i++) {
      var stroke = strokes[i];
      shape.subElements.push(stroke.id);
    }
    shape.time = firstTime;
    shape.interpretation = interpretation;
    shape.confidence = "1.0";

    // id, time, domain, strokes, shapes
    var sketch = {};
    sketch.id = id;
    sketch.time = firstTime;
    sketch.domain =  domainString.split(",");;
    sketch.canvasWidth = Number.parseInt(canvas.width);;
    sketch.canvasHeight = Number.parseInt(canvas.height);;
    sketch.strokes = strokes;
    sketch.shapes = [shape];

    return sketch;
  }

  function readJson(fileName) {
    var contents;
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState === 4 && this.status === 200) {
        contents = JSON.parse(this.response);
      }
    };
    xhttp.open("GET", fileName, false);
    xhttp.send();
    return contents;
  }    

  function saveSketch(sketch) {
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "http://localhost:3000/saveSkeptCha", false);
    xhr.setRequestHeader("Content-Type", "application/json; charset=UTF-8");
    var data = JSON.stringify(sketch);
    xhr.send(data);
  }
    
</script>
  
</body>
</html>
